<div id="adyen-encrypted-form">
  <%= image_tag 'credit_cards/credit_card.gif', :id => 'credit-card-image' %>
  <% param_prefix = "payment_source[#{payment_method.id}]" %>

  <p class="field">
    <%= label_tag "name_on_card_#{payment_method.id}", Spree.t(:name_on_card) %><span class="required">*</span><br />
    <%= text_field_tag "#{param_prefix}[name]", "#{@order.billing_firstname} #{@order.billing_lastname}", :id => "name_on_card_#{payment_method.id}",  'data-encrypted-name' => "holderName" %>
  </p>

  <p class="field" data-hook="card_number">
    <%= label_tag "card_number", Spree.t(:card_number) %><span class="required">*</span><br />
    <% options_hash = Rails.env.production? ? {:autocomplete => 'off'} : {} %>
    <%= text_field_tag "", '', options_hash.merge(:id => 'card_number', :class => 'required cardNumber', :size => 19, :maxlength => 19, 'data-encrypted-name' => "number") %>
    &nbsp;
    <span id="card_type" style="display:none;">
      ( <span id="looks_like" ><%= Spree.t(:card_type_is) %> <span id="type"></span></span>
        <span id="unrecognized"><%= Spree.t(:unrecognized_card_type) %></span>
      )
    </span>
  </p>

  <p class="field" data-hook="card_expiration">
    <%= label_tag "card_expiry", Spree.t(:expiration) %><span class="required">*</span><br />
    <%= text_field_tag "#{param_prefix}[month]", '', :id => 'card_expiry_month', :class => "required", :placeholder => "MM", :size => 5, :maxlength => 2, :autocomplete => "off", 'data-encrypted-name' => "expiryMonth" %>
    <%= text_field_tag "#{param_prefix}[year]", '', :id => 'card_expiry_year', :class => "required", :placeholder => "YYYY", :size => 5, :maxlength => 4, :autocomplete => "off", 'data-encrypted-name' => "expiryYear" %>
  </p>

  <p class="field" data-hook="card_code">
    <%= label_tag "card_code", Spree.t(:card_code) %><span class="required">*</span><br />
    <%= text_field_tag "", '', options_hash.merge(:id => 'card_code', :class => 'required cardCode', :size => 5, 'data-encrypted-name' => "cvc") %>
    <%= link_to "(#{Spree.t(:what_is_this)})", spree.content_path('cvv'), :target => '_blank', "data-hook" => "cvv_link", :id => "cvv_link" %>
  </p>

  <input type="hidden" id="adyen-encrypted-form-expiry-generationtime" value="<%= DateTime.current() %>" data-encrypted-name="generationtime" />

</div>
<%= javascript_include_tag "adyen.encrypt.min.js" %>

<script>    
    var form = document.getElementById('checkout_form_payment');    
    var key = "<%= payment_method.options[:public_key] %>";
    var options = {
      'name': "<%= "#{param_prefix}[verification_value]" %>"
    }; 
    
    // the form will be encrypted before it is submitted
    adyen.encrypt.createEncryptedForm(form, key, options);
</script>